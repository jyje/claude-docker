name: cron-fetch-npm

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  check-claude-version:
    name: ðŸ” Check NPM Version
    runs-on: ubuntu-24.04-arm
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      UPDATE_NEEDED: 'false'
      TARGET_VERSION: ''
      PR_EXISTS: 'false'
      HAS_OPEN_VERSION_PR: 'false'
      TAG_EXISTS: 'false'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'

      - name: Fetch all NPM versions
        id: npm_versions
        run: |
          npm view @anthropic-ai/claude-code versions --json | jq -r '.[]' > npm_versions.txt
          echo "Fetched $(wc -l < npm_versions.txt) versions from npm"

      - name: Find oldest missing version vs git tags
        id: pick_oldest
        run: |
          git fetch --unshallow --tags
          git tag -l 'v*' | sed 's/^v//' | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' | sort -u > tagged_versions.txt
          # Only consider v2.1.34+ (current latest tag as minimum)
          (cat npm_versions.txt; echo "2.1.34") | sort -V | uniq | awk 'BEGIN{found=0} /^2\.1\.34$/{found=1} found{print}' | sort -u > n.txt
          echo "Considering $(wc -l < n.txt) npm versions (>= 2.1.34)"
          sort -u tagged_versions.txt > t.txt
          comm -23 n.txt t.txt > missing_versions.txt
          TARGET_VERSION=$(sort -V missing_versions.txt | head -n 1)
          if [ -z "$TARGET_VERSION" ]; then
            echo "No missing versions; all npm versions have a tag."
            echo "UPDATE_NEEDED=false" >> $GITHUB_ENV
          else
            echo "Oldest missing version: $TARGET_VERSION"
            echo "TARGET_VERSION=$TARGET_VERSION" >> $GITHUB_ENV
            echo "UPDATE_NEEDED=true" >> $GITHUB_ENV
          fi

      - name: Check for existing PR and open version PRs
        if: env.UPDATE_NEEDED == 'true'
        id: check_pr
        run: |
          PR_TITLE="[v${{ env.TARGET_VERSION }}] update claude-code version"
          gh pr list --state open --base main --json title > pr_list.json
          # PR for this specific version already open?
          jq -e ".[] | select(.title == \"$PR_TITLE\")" pr_list.json >/dev/null 2>&1 && \
            echo "PR_EXISTS=true" >> $GITHUB_ENV || echo "PR_EXISTS=false" >> $GITHUB_ENV
          # Any open version PR (avoid multiple open version PRs â†’ merge conflicts when one is merged)
          OPEN_COUNT=$(jq -r '.[].title' pr_list.json | grep -cE '^\[v[0-9]+\.[0-9]+\.[0-9]+\] update claude-code version$' || true)
          if [ "${OPEN_COUNT:-0}" -ge 1 ]; then
            echo "HAS_OPEN_VERSION_PR=true" >> $GITHUB_ENV
          else
            echo "HAS_OPEN_VERSION_PR=false" >> $GITHUB_ENV
          fi

      - name: Check for existing tag
        uses: Wandalen/wretry.action@v3
        id: check_tag
        if: env.UPDATE_NEEDED == 'true' && env.PR_EXISTS == 'false' && env.HAS_OPEN_VERSION_PR == 'false'
        with:
          attempt_limit: 3
          attempt_delay: 10000
          command: |
            git fetch --tags
            git tag --list "v${{ env.TARGET_VERSION }}" > tag_list.txt
            if [ -s tag_list.txt ]; then
              echo "TAG_EXISTS=true" >> $GITHUB_ENV
            else
              echo "TAG_EXISTS=false" >> $GITHUB_ENV
            fi

      - name: Create new branch and update version
        if: env.UPDATE_NEEDED == 'true' && env.PR_EXISTS == 'false' && env.HAS_OPEN_VERSION_PR == 'false' && env.TAG_EXISTS == 'false'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b version/${{ env.TARGET_VERSION }} main
          
          # Update package.json: dependencies and version
          jq '.dependencies["@anthropic-ai/claude-code"] = "${{ env.TARGET_VERSION }}" | .version = "${{ env.TARGET_VERSION }}"' package.json > package.json.tmp
          mv package.json.tmp package.json
          
          # Update Dockerfile ARG default value for reproducibility
          sed -i "s/^ARG CLAUDE_CODE_VERSION=.*/ARG CLAUDE_CODE_VERSION=${{ env.TARGET_VERSION }}/" Dockerfile
          
          git add package.json Dockerfile
          git commit -m "âœ¨ version: for v${{ env.TARGET_VERSION }}" --allow-empty
          git push origin version/${{ env.TARGET_VERSION }}

      - name: Create PR
        if: env.UPDATE_NEEDED == 'true' && env.PR_EXISTS == 'false' && env.HAS_OPEN_VERSION_PR == 'false' && env.TAG_EXISTS == 'false'
        run: |
          MISSING_CHECKLIST=$(sort -V missing_versions.txt | while IFS= read -r v; do echo "- [ ] v$v"; done)
          PR_BODY=$(printf "Automatically created PR to update Claude Code version to v%s\n\n### Upstream versions not yet built\n\n%s" "${{ env.TARGET_VERSION }}" "$MISSING_CHECKLIST")
          gh pr create \
            --title "[v${{ env.TARGET_VERSION }}] update claude-code version" \
            --body "$PR_BODY" \
            --base main \
            --head version/${{ env.TARGET_VERSION }} \
            --assignee "${{ github.repository_owner }}"
