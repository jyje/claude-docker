name: cron-fetch-npm

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  check-claude-version:
    name: ðŸ” Check NPM Version
    runs-on: ubuntu-24.04-arm
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Check for new Claude Code version
        id: check_version
        run: |
          NEW_VERSION=$(npm view @anthropic-ai/claude-code version)
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV
          echo "Found latest version: $NEW_VERSION"

      - name: Get current version
        id: current_version
        run: |
          CURRENT_VERSION=$(cat package.json | jq -r '.dependencies["@anthropic-ai/claude-code"]')
          echo "CURRENT_VERSION=$CURRENT_VERSION" >> $GITHUB_ENV
          echo "Current version: $CURRENT_VERSION"

      - name: Check if update needed
        id: check_update
        run: |
          if [ "$NEW_VERSION" = "$CURRENT_VERSION" ]; then
            echo "Version is already up to date: $CURRENT_VERSION"
            echo "UPDATE_NEEDED=false" >> $GITHUB_ENV
          else
            echo "Update available: $CURRENT_VERSION -> $NEW_VERSION"
            echo "UPDATE_NEEDED=true" >> $GITHUB_ENV
          fi

      - name: Check for existing PR
        if: env.UPDATE_NEEDED == 'true'
        id: check_pr
        run: |
          PR_TITLE="[v${{ env.NEW_VERSION }}] update claude-code version"
          gh pr list --search "$PR_TITLE" --json title > pr_list.json
          jq -e ".[] | select(.title == \"$PR_TITLE\")" pr_list.json && \
            echo "PR_EXISTS=true" >> $GITHUB_ENV || \
            echo "PR_EXISTS=false" >> $GITHUB_ENV

      - name: Check for existing tag
        uses: Wandalen/wretry.action@v3
        id: check_tag
        if: env.UPDATE_NEEDED == 'true' && env.PR_EXISTS == 'false'
        with:
          attempt_limit: 3
          attempt_delay: 10000
          command: |
            git fetch --unshallow --tags
            git tag --list "v${{ env.NEW_VERSION }}" > tag_list.txt
            if [ -s tag_list.txt ]; then
              echo "TAG_EXISTS=true" >> $GITHUB_ENV
            else
              echo "TAG_EXISTS=false" >> $GITHUB_ENV
            fi

      - name: Create new branch and update version
        if: env.UPDATE_NEEDED == 'true' && env.PR_EXISTS == 'false' && env.TAG_EXISTS == 'false'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b version/${{ env.NEW_VERSION }} main
          
          # Update package.json with new version
          jq '.dependencies["@anthropic-ai/claude-code"] = "${{ env.NEW_VERSION }}"' package.json > package.json.tmp
          mv package.json.tmp package.json
          
          # Update Dockerfile ARG default value for reproducibility
          sed -i "s/^ARG CLAUDE_CODE_VERSION=.*/ARG CLAUDE_CODE_VERSION=${{ env.NEW_VERSION }}/" Dockerfile
          
          git add package.json Dockerfile
          git commit -m "âœ¨ version: for v${{ env.NEW_VERSION }}" --allow-empty
          git push origin version/${{ env.NEW_VERSION }}

      - name: Create PR
        if: env.UPDATE_NEEDED == 'true' && env.PR_EXISTS == 'false' && env.TAG_EXISTS == 'false'
        run: |
          gh pr create \
            --title "[v${{ env.NEW_VERSION }}] update claude-code version" \
            --body "Automatically created PR to update Claude Code version to v${{ env.NEW_VERSION }}" \
            --base main \
            --head version/${{ env.NEW_VERSION }}
